FROM golang:alpine AS builder

MAINTAINER 0xO1

EXPOSE 9692

RUN apk --update add --no-cache ca-certificates git && go get github.com/golang/dep/cmd/dep

WORKDIR /go/src/github.com/0x0I/gcp-gce-exporter
COPY Gopkg.toml Gopkg.lock ./
RUN dep ensure --vendor-only

COPY src/ /go/src/github.com/0x0I/gcp-gce-exporter/
RUN GOPATH=/go go get && GOPATH=/go go build -o /bin/gcp-gce-exporter

FROM alpine:latest
COPY --from=builder /bin/gcp-gce-exporter /usr/bin/gcp-gce-exporter
ENTRYPOINT [ "gcp-gce-exporter" ]

ENV EXPORTER_USER=exporter
RUN addgroup -S $EXPORTER_USER && adduser --no-create-home --system $EXPORTER_USER $EXPORTER_USER
USER $EXPORTER_USER
